<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONTE SEU ACAI - SABOR A√áA√çTERIA</title>

    <meta property="og:title" content="MONTE SEU ACAI - SABOR A√áA√çTERIA">
    <meta property="og:description" content="Confira nosso card√°pio completo de a√ßa√≠s, cremes e combos. Monte o seu e pe√ßa agora!">
    <meta property="og:image" content="https://raw.githubusercontent.com/saboracaiteria/SABOR-/main/175.jpg"> 
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://saboracaiteria.github.io/SABOR-/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MONTE SEU ACAI - SABOR A√áA√çTERIA">
    <meta name="twitter:description" content="Confira nosso card√°pio completo de a√ßa√≠s, cremes e combos. Monte o seu e pe√ßa agora!">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/saboracaiteria/SABOR-/main/175.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Base font inspired by Instagram's clean look */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000000; /* Super AMOLED Black */
        }
        
        /* Instagram Gradient Text */
        .instagram-gradient-text {
            background: linear-gradient(90deg, #f9ce34, #ee2a7b, #6228d7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        /* Instagram Gradient for Buttons */
        .btn-gradient {
            background-image: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            transition: opacity 0.3s ease;
        }
        .btn-gradient:hover {
            opacity: 0.9;
        }

        /* Custom scrollbar for modal content */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #1F2937; /* gray-800 */
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* gray-500 */
        }

        /* Hide spin buttons for number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Custom Checkbox and Radio Styles */
        input[type="checkbox"]:checked, input[type="radio"]:checked {
            background-color: #ee2a7b;
            border-color: #ee2a7b;
        }
        
        /* Highlight radio button card when checked */
        input[type="radio"]:checked + div {
             border-color: #ee2a7b;
             box-shadow: 0 0 10px rgba(238, 42, 123, 0.5);
        }

        /* Transitions for modals */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .modal.flex {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        /* Product card hover effect */
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        /* Bouncing arrow animation */
        @keyframes bounce-horizontal {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(0);
            }
            40% {
                transform: translateX(-10px);
            }
            60% {
                transform: translateX(-5px);
            }
        }
        .animate-bounce-horizontal {
            animation: bounce-horizontal 2s infinite;
        }
    </style>
</head>
<body class="bg-black text-gray-300">

    <div id="closing-timer-container" class="hidden fixed top-2 left-4 text-xs text-gray-200 z-50 bg-gray-900 bg-opacity-80 border border-gray-700 px-3 py-1 rounded-full shadow-lg items-center gap-2">
        <i class="fas fa-stopwatch text-red-400"></i>
        <div>Fecha em: <span id="closing-timer" class="font-bold tracking-wider">--:--:--</span></div>
    </div>

    <div id="opening-timer-container" class="hidden fixed top-11 left-4 text-xs text-gray-200 z-50 bg-gray-900 bg-opacity-80 border border-gray-700 px-3 py-1 rounded-full shadow-lg items-center gap-2">
        <i class="fas fa-stopwatch text-green-400"></i>
        <div>Abre em: <span id="opening-timer" class="font-bold tracking-wider">--:--:--</span></div>
    </div>

    <div id="delivery-countdown-container" class="hidden fixed top-20 left-4 text-xs text-gray-200 z-50 bg-gray-900 bg-opacity-80 border border-gray-700 px-3 py-1 rounded-full shadow-lg items-center gap-2">
        <i class="fas fa-motorcycle text-blue-400"></i>
        <div>Delivery em: <span id="delivery-countdown-timer" class="font-bold tracking-wider">--:--:--</span></div>
    </div>

    <div id="online-counter-container" class="fixed top-2 right-4 text-xs text-gray-300 flex items-center z-50 bg-gray-900 bg-opacity-70 border border-gray-700 px-2 py-1 rounded-full shadow-lg">
        <span class="relative flex h-2 w-2 mr-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        <div><span id="online-count">12</span> pessoas online</div>
    </div>


    <div class="container mx-auto p-4 max-w-3xl">

        <header class="flex items-center gap-4 md:gap-8 mb-8 p-4 border-b border-gray-800">
            <div class="w-20 h-20 md:w-28 md:h-28 rounded-full flex-shrink-0 bg-gray-800 p-1 flex items-center justify-center instagram-gradient-bg-ring" style="background: linear-gradient(45deg, #f9ce34, #ee2a7b, #6228d7);">
                <div class="bg-gray-900 rounded-full w-full h-full p-0.5">
                      <img src="175.jpg" alt="Logo da Sabor A√ßa√≠teria" class="w-full h-full rounded-full object-cover">
                </div>
            </div>
            <div class="flex-grow">
                <div class="flex items-center gap-2">
                    <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-gray-100">sabor acaiteria</h1>
                </div>
                <p class="text-sm text-gray-400 mt-2">
                    <i class="fas fa-clock mr-1 opacity-70"></i>
                    <span id="store-hours-display">Carregando hor√°rio...</span>
                    <span id="store-status-indicator" class="ml-2 px-2 py-0.5 text-xs rounded-full font-semibold"></span>
                </p>
                <p class="text-xs text-gray-400 mt-2">Cana√£ dos Caraj√°s</p>
                <p id="store-address-display" class="text-xs text-gray-500 mt-1">Carregando endere√ßo...</p>
                <div class="mt-4 flex justify-around text-center">
                    <div>
                        <p class="font-bold text-gray-100">38</p>
                        <p class="text-sm text-gray-400">posts</p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-100">1.679</p>
                        <p class="text-sm text-gray-400">seguidores</p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-100">3.541</p>
                        <p class="text-sm text-gray-400">seguindo</p>
                    </div>
                </div>
                <div class="mt-4 flex gap-2 items-center relative">
                    <div class="absolute -left-12 text-green-400 animate-bounce-horizontal">
                        <i class="fas fa-arrow-right text-4xl" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));"></i>
                    </div>
                    <a href="https://www.instagram.com/sabor_acaiteria/profilecard/?igsh=NjF2ZWMwNHNiNzI0" target="_blank" class="flex-1 text-center btn-gradient text-white font-bold py-2 px-4 rounded-lg text-sm">
                        Seguir
                    </a>
                    <a id="message-button-link" href="#" target="_blank" class="flex-1 text-center btn-gradient text-white font-bold py-2 px-4 rounded-lg text-sm">
                        Mensagem
                    </a>
                    <a href="https://aiqfome.com/PA/canaa-dos-carajas/sabor-acaiteria" target="_blank" class="flex-1 text-center btn-gradient text-white font-bold py-2 px-4 rounded-lg text-sm">
                        aiqfome
                    </a>
                </div>
            </div>
        </header>


        <div id="store-status-banner" class="hidden mb-6"></div>
        <div id="delivery-time-banner" class="hidden mb-6"></div>

        <main class="space-y-8">
            <section id="tamanhos">
                <p class="text-lg text-gray-400 mb-4 text-center">üëá Clique em <span class="font-bold text-white">"Montar"</span> para come√ßar üëá</p>
                <h2 class="text-2xl font-bold text-gray-100 mb-4 tracking-wide">MONTE SEU A√áA√ç</h2>
                <div id="product-list" class="grid grid-cols-2 gap-3">
                    </div>
            </section>
        </main>

        <footer class="text-center mt-12 space-y-4 py-6 border-t border-gray-800">
            <div class="text-gray-500 text-sm">
                <p>Siga-nos no Instagram: 
                    <a href="https://www.instagram.com/sabor_acaiteria/profilecard/?igsh=NjF2ZWMwNHNiNzI0" target="_blank" class="font-semibold text-gray-300 hover:underline">@sabor_acaiteria</a>
                </p>
                 <a href="#" onclick="app.openAdminPanel(event)" class="mt-4 inline-block text-gray-600 hover:text-gray-400 transition-colors text-xs">
                    Painel do Administrador
                </a>
            </div>
        </footer>
    </div>

    <a id="whatsapp-link" href="#" target="_blank" class="fixed bottom-5 left-5 z-50">
        <button class="bg-green-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">
            <i class="fab fa-whatsapp text-3xl"></i>
        </button>
    </a>

    <div id="cart-button" class="fixed bottom-5 right-5 z-50 hidden">
        <button onclick="app.toggleCartModal()" class="btn-gradient text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform transform hover:scale-110">
            <i class="fas fa-shopping-bag text-2xl"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-gray-800">0</span>
        </button>
    </div>

    <div id="combo-size-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 text-gray-300 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="combo-size-modal-title" class="text-xl font-bold text-white">Escolha o Tamanho</h3>
                <button onclick="app.closeComboSizeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="combo-size-modal-body" class="p-6 space-y-4 overflow-y-auto modal-body">
                </div>
            <div class="p-4 bg-black border-t border-gray-700 flex justify-end">
                <button id="select-combo-size-btn" class="btn-gradient text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Continuar <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="item-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 text-gray-300 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-white">Monte seu A√ßa√≠</h3>
                <button onclick="app.closeItemModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                </div>
            <div class="p-4 bg-black border-t border-gray-700 flex justify-between items-center">
                <div>
                    <span class="text-md font-medium text-gray-400">Total:</span>
                    <span id="modal-item-total" class="text-2xl font-bold text-white ml-2">R$ 0,00</span>
                </div>
                <button id="add-to-cart-btn" class="btn-gradient text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2">
                    Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
         <div class="bg-gray-900 border border-gray-700 text-gray-300 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Seu Carrinho e Pedido</h3>
                <button onclick="app.toggleCartModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <div id="cart-items-container"></div>
                
                <div class="space-y-3 pt-4 pb-4 border-t border-gray-700">
                    <h4 class="text-lg font-bold text-white">Cupom de Desconto</h4>
                    <div id="coupon-input-group" class="flex gap-2">
                        <input type="text" id="coupon-code" class="mt-1 block flex-1 bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white placeholder-gray-400 uppercase" placeholder="Insira o Cupom">
                        <button id="apply-coupon-btn" class="btn-gradient text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0">Aplicar</button>
                    </div>
                    <div id="coupon-message" class="text-sm pl-1 min-h-[1.25rem]"></div>
                    <div id="applied-coupon-display" class="hidden flex justify-between items-center bg-gray-800 p-3 rounded-lg border border-pink-500">
                        <span class="text-pink-400 font-semibold"><i class="fas fa-tag mr-2"></i>Cupom Aplicado: <span id="applied-coupon-code" class="text-white"></span></span>
                        <button onclick="app.removeCoupon()" class="text-gray-400 hover:text-red-500 text-lg"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div id="cart-summary-details" class="pt-4 mt-4 border-t border-gray-700 space-y-2 hidden">
                      <div class="flex justify-between text-gray-400">
                          <span>Subtotal</span>
                          <span id="cart-subtotal">R$ 0,00</span>
                      </div>
                      <div class="flex justify-between text-gray-400">
                          <span>Taxa de Entrega</span>
                          <span id="cart-delivery-fee">R$ 0,00</span>
                      </div>
                </div>
                <div id="checkout-form" class="space-y-4 pt-6 border-t border-gray-700 hidden">
                    <h4 class="text-lg font-bold text-white">Informa√ß√µes do Pedido</h4>
                    <div id="delivery-options">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label id="delivery-option-delivery" class="flex-1">
                                <input type="radio" name="delivery_option" value="delivery" class="hidden" checked>
                                <div class="flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer transition-all">
                                    <div class="flex items-center">
                                        <span class="mr-3"><i class="fas fa-motorcycle text-xl text-pink-500"></i></span>
                                        <div><span class="font-semibold text-gray-200 block">Delivery</span><span class="text-sm text-gray-500">20-60 min</span></div>
                                    </div>
                                </div>
                            </label>
                            <label id="delivery-option-takeout" class="flex-1">
                                <input type="radio" name="delivery_option" value="takeout" class="hidden">
                                <div class="flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer transition-all">
                                    <div class="flex items-center">
                                        <span class="mr-3"><i class="fas fa-store text-xl text-pink-500"></i></span>
                                        <div><span class="font-semibold text-gray-200 block">Retirar na Loja</span><span class="text-sm text-gray-500">20-30 min</span></div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <input type="text" id="customer-name" class="mt-1 block w-full bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white placeholder-gray-400" placeholder="Seu Nome" required>
                    </div>
                    <div id="delivery-fields" class="space-y-4">
                         <div>
                            <select id="neighborhood" class="mt-1 block w-full bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white">
                                <option value="" data-fee="0">-- Selecione o Bairro --</option>
                                <option value="Jardim Europa" data-fee="9.00">Jardim Europa (R$ 9,00)</option>
                                <option value="Amec" data-fee="9.00">Amec (R$ 9,00)</option>
                                <option value="Vale dos Sonhos 1" data-fee="9.00">Vale dos Sonhos 1 (R$ 9,00)</option>
                                <option value="Vale dos Sonhos 2" data-fee="9.00">Vale dos Sonhos 2 (R$ 9,00)</option>
                                <option value="Vale da Ben√ß√£o" data-fee="9.00">Vale da Ben√ß√£o (R$ 9,00)</option>
                                <option value="Jardim do Lago" data-fee="12.00">Jardim do Lago (R$ 12,00)</option>
                                <option value="Casas Populares" data-fee="9.00">Casas Populares (R$ 9,00)</option>
                                <option value="Nova Esperan√ßa 2" data-fee="9.00">Nova Esperan√ßa 2 (R$ 9,00)</option>
                                <option value="Outro Bairro" data-fee="7.00">Outro Bairro (Taxa Padr√£o R$ 7,00)</option>
                            </select>
                        </div>
                        <div>
                            <input type="text" id="customer-address" class="mt-1 block w-full bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white placeholder-gray-400" placeholder="Endere√ßo Completo (Rua, N√∫mero, Comp.)" required>
                        </div>
                    </div>
                     <div>
                        <select id="payment-method" class="mt-1 block w-full bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white">
                            <option>Pix</option>
                            <option>Cart√£o de Cr√©dito (na entrega)</option>
                            <option>Cart√£o de D√©bito (na entrega)</option>
                            <option>Dinheiro</option>
                        </select>
                        <p class="text-xs text-yellow-400 mt-2"><i class="fas fa-info-circle mr-1"></i>Observa√ß√£o: n√£o aceitamos VR e vales refei√ß√£o no momento.</p>
                    </div>
                     <div>
                        <textarea id="observations" rows="3" class="mt-1 block w-full bg-gray-800 border-2 border-gray-600 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500 p-3 text-base text-white placeholder-gray-400" placeholder="Observa√ß√µes (Ex: Troco para R$50, sem cebola, etc.)"></textarea>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-black border-t border-gray-700 flex justify-between items-center">
                 <div>
                    <span class="text-md font-medium text-gray-400">Total:</span>
                    <span id="cart-total" class="text-2xl font-bold text-white ml-2">R$ 0,00</span>
                </div>
                <button onclick="app.finalizeOrder()" class="btn-gradient text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                    <i class="fab fa-whatsapp"></i> Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 text-gray-300 rounded-2xl shadow-2xl w-full max-w-lg text-center p-8">
            <div id="confirmation-icon"><i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i></div>
            <h3 id="confirmation-title" class="text-2xl font-bold text-white mb-2">Pedido Recebido!</h3>
            <p id="confirmation-message" class="text-gray-400 mb-6">Seu pedido foi gerado! Clique no bot√£o abaixo para encaminh√°-lo para o WhatsApp da loja e finalizar a compra.</p>
            <div id="order-summary" class="text-left bg-gray-800 p-4 rounded-lg mb-6 max-h-60 overflow-y-auto modal-body"></div>
            <div id="initial-confirm-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button onclick="app.sendOrderViaWhatsApp()" class="w-full btn-gradient text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Enviar Pedido
                </button>
                <button onclick="app.closeConfirmationModal()" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Fechar</button>
            </div>
            <div id="post-send-buttons" class="hidden flex-col gap-4 justify-center">
                 <p class="text-sm text-yellow-400 mb-4">Ap√≥s enviar a mensagem no WhatsApp, confirme abaixo para limpar seu carrinho.</p>
                 <button onclick="app.confirmOrderSent()" class="w-full btn-gradient text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-square"></i> Pedido Enviado, Limpar Carrinho
                </button>
                <button onclick="app.closeConfirmationModal()" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Manter Carrinho e Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-[60] hidden items-center justify-center p-4">
        <div class="bg-gray-900 text-gray-300 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="alert-icon" class="mx-auto mb-4"></div>
            <h3 id="alert-title" class="text-xl font-bold text-white mb-2">Aten√ß√£o!</h3>
            <p id="alert-message" class="text-gray-400 mb-6">Mensagem de alerta.</p>
            <button onclick="app.closeAlertModal()" class="w-full btn-gradient text-white font-bold py-2 px-6 rounded-lg transition-all">OK</button>
        </div>
    </div>
    
    <div id="admin-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-[70] hidden items-center justify-center p-4">
        <div class="bg-gray-900 text-gray-200 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-yellow-400"><i class="fas fa-user-shield mr-2"></i>Painel do Administrador</h3>
                <button onclick="app.closeAdminModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="admin-body" class="p-6 space-y-6 overflow-y-auto modal-body"></div>
            <div class="p-4 bg-black border-t border-gray-700 flex flex-wrap justify-between items-center gap-4">
                <button onclick="app.saveAdminChanges()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i> Salvar Altera√ß√µes</button>
                <button onclick="app.resetToDefaults()" class="bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-yellow-700"><i class="fas fa-undo mr-2"></i> Restaurar Padr√£o</button>
            </div>
        </div>
    </div>
    <div id="password-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-900 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-xl font-bold text-yellow-400 mb-4">Acesso Restrito</h3>
            <p class="text-gray-400 mb-4">Insira a senha de administrador.</p>
            <input type="password" id="admin-password-input" class="block w-full bg-gray-800 border-2 border-gray-600 rounded-md p-3 text-white">
            <div class="mt-6 flex gap-4">
                <button onclick="app.closePasswordModal()" class="w-full bg-gray-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancelar</button>
                <button onclick="app.checkAdminPassword()" class="w-full bg-yellow-600 text-gray-900 font-bold py-2 px-6 rounded-lg hover:bg-yellow-700">Entrar</button>
            </div>
        </div>
    </div>
    <div id="confirm-action-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-900 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="confirm-action-icon" class="mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-500 text-5xl"></i></div>
            <h3 id="confirm-action-title" class="text-xl font-bold text-gray-100 mb-2">Confirmar A√ß√£o</h3>
            <p id="confirm-action-message" class="text-gray-400 mb-6">Voc√™ tem certeza?</p>
            <div class="mt-6 flex gap-4">
                <button id="confirm-action-cancel-btn" class="w-full bg-gray-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancelar</button>
                <button id="confirm-action-confirm-btn" class="w-full bg-red-600 font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
    // --- APP GLOBAL OBJECT ---
    const app = {
        // --- APPLICATION STATE ---
        cart: [],
        currentItem: null,
        whatsAppMessage: '',
        isStoreOpen: false,
        isDeliveryTime: false,
        adminSettings: {},
        products: [],
        toppings: {},
        selectedComboProductId: null,
        countdownInterval: null,
        openingCountdownInterval: null,
        deliveryCountdownInterval: null,

        // --- COUPON STATE & DATA (NOVAS ADI√á√ïES) ---
        coupon: {
            applied: null, // { code: '...', type: '...', value: 0, message: '...' }
            usedCoupons: {} // { 'COUPON_CODE': 'YYYY-MM-DD' }
        },
        COUPON_STORAGE_KEY: 'saborAcaiteriaUsedCoupons',
        COUPON_DISCOUNTS: {
            'TAXA-0': { type: 'free_delivery', value: 0, message: 'Taxa de Entrega Gr√°tis aplicada!' },
            'SABOR10': { type: 'percentage', value: 0.10, message: '10% de desconto no Subtotal aplicado!' },
            'SABOR15': { type: 'percentage', value: 0.15, message: '15% de desconto no Subtotal aplicado!' },
            'SABOR21': { type: 'percentage', value: 0.21, message: '21% de desconto no Subtotal aplicado!' },
        },
        
        // --- DEFAULT DATA (for initial load or reset) ---
        defaultAdminSettings: {
            // ALTERADO PARA TESTE: Loja ABERTA
            storeStatus: 'open', // 'auto', 'open', 'closed'
            deliveryMode: 'both', // 'both', 'delivery', 'takeout'
            openingTime: '10:00', // ALTERADO PARA TESTE
            closingTime: '23:59', // ALTERADO PARA TESTE
            openDays: [0, 1, 2, 3, 4, 5, 6],
            whatsappNumber: '5594991623576',
            address: 'Av. rio Branco. novo Horizonte.. antigo Obba a√ßa√≠',
            weekdayDeliveryStartTime: '19:15',
            weekendDeliveryStartTime: '15:30'
        },
        defaultProducts: [
            { id: 1, name: 'Copo 300ml', price: 14.00, disabled: false, type: 'base_acai', description: 'Monte seu a√ßa√≠ com seus acompanhamentos preferidos.' },
            { id: 2, name: 'Copo 400ml', price: 17.00, disabled: false, type: 'base_acai', description: 'Monte seu a√ßa√≠ com seus acompanhamentos preferidos.' },
            { id: 3, name: 'Copo 500ml', price: 20.00, disabled: false, type: 'base_acai', description: 'Monte seu a√ßa√≠ com seus acompanhamentos preferidos.' },
            { id: 22, name: 'Barca de A√ßa√≠ (P)', price: 55.00, disabled: false, type: 'base_acai', description: 'Monte sua barca com at√© 7 ingredientes e 2 caldas!', customToppingLimits: { free: 7, caldas: 2 } },
            { id: 5, name: 'Diet Granola', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: granola, leite em p√≥, leite condensado', sizesKey: 'cupSizes' },
            { id: 6, name: 'Refrescante', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: sorvete, calda de chocolate, leite em p√≥, leite condensado', sizesKey: 'cupSizes' },
            { id: 7, name: 'Mega Especial', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: leite em p√≥, leite condensado, banana, creme de avel√£ (Nutella)', sizesKey: 'cupSizes' },
            { id: 8, name: 'Preferido', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: pa√ßoca, leite em p√≥, leite condensado, creme de avel√£ (Nutella)', sizesKey: 'cupSizes' },
            { id: 9, name: 'Maltine +', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: ovomaltine, tapioca, leite em p√≥, leite condensado', sizesKey: 'cupSizes' },
            { id: 10, name: 'Amendoimix', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: amendoim, leite em p√≥, leite condensado', sizesKey: 'cupSizes' },
            { id: 11, name: 'Megapower', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: chocopower, leite em p√≥, leite condensado, creme de avel√£ (Nutella)', sizesKey: 'cupSizes' },
            { id: 12, name: 'A√ßa√≠ Banana', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: leite em p√≥, tapioca, leite condensado, banana', sizesKey: 'cupSizes' },
            { id: 13, name: 'Favorito Nutella', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: flocos, leite condensado, leite em p√≥, creme de avel√£ (Nutella)', sizesKey: 'cupSizes' },
            { id: 14, name: 'Sabores do Par√°', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: banana, uva, leite em p√≥, leite condensado, creme de avel√£ (Nutella)', sizesKey: 'cupSizes' },
            { id: 15, name: 'Kids Especial', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: M&M\'s, uva, creme de avel√£ (Nutella), leite em p√≥, leite condensado, banana', sizesKey: 'cupSizes' },
            { id: 16, name: 'Namorados', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: uva, morango, creme de avel√£ (Nutella), leite em p√≥, leite condensado', sizesKey: 'cupSizes' },
            { id: 17, name: 'Kitkat', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: KitKat, creme de avel√£, leite em p√≥, calda de chocolate', sizesKey: 'cupSizes' },
            { id: 18, name: 'Euforia', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: morango, kiwi, banana, leite em p√≥, calda de morango', sizesKey: 'cupSizes' },
            { id: 19, name: 'Ninho (A)', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: leite em po, morango, banana, leite condensado', sizesKey: 'cupSizes' },
            { id: 20, name: 'Bombom', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: Sonho de Valsa, leite em p√≥, calda de chocolate, creme de avel√£', sizesKey: 'cupSizes' },
            { id: 21, name: 'Maracuj√°', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: mousse de maracuj√°, creme de avel√£, leite em p√≥, calda de chocolate', sizesKey: 'cupSizes' },
        ],
        cupSizes: [
            { name: '300ml', price: 14.00 },
            { name: '400ml', price: 17.00 },
            { name: '500ml', price: 20.00 }
        ],
        defaultToppings: {
            free: {
                title: 'üçì Frutas, Cremes e Gr√£os (Gr√°tis, escolha at√© 3)', limit: 3, items: [
                    { name: 'Amendoim' }, { name: 'Aveia' }, { name: 'Banana' }, { name: 'Coco Ralado' }, { name: 'Creme de Avel√£' }, 
                    { name: 'Creme de Cupua√ßu' }, { name: 'Creme de Leite Ninho' }, { name: 'Flocos' }, { name: 'Granola Tradicional' },
                    { name: 'Kiwi' }, { name: 'Leite em P√≥' }, { name: 'Manga' }, { name: 'Morango' }, { name: 'Mousse de Maracuj√°' },
                    { name: 'Pa√ßoca' }, { name: 'Sorvete' }, { name: 'Tapioca' }, { name: 'Uva' }
                ].map(item => ({ ...item, disabled: false }))
            },
            caldas: {
                title: 'üçØ Caldas (Gr√°tis, escolha at√© 1)', limit: 1, items: [
                    { name: 'Calda de A√ßa√≠' }, { name: 'Calda de Caramelo' }, { name: 'Calda de Chocolate' }, 
                    { name: 'Calda de Kiwi' }, { name: 'Calda de Morango' }, { name: 'Leite Condensado' }
                ].map(item => ({ ...item, disabled: false }))
            },
            paid_tier2: {
                title: 'üç´ Doces e Chocolates (+ R$ 2,00 cada)', price: 2.00, items: [
                    { name: 'Bis Picado' }, { name: 'Chocopower' }, { name: 'Confetes' }, { name: 'Gotas de Chocolate' },
                    { name: 'KitKat' }, { name: 'M&M\'s' }, { name: 'Ovomaltine' }, { name: 'Sonho de Valsa' } 
                ].map(item => ({ ...item, disabled: false }))
            }
        },

        // --- LOCAL STORAGE KEYS ---
        CART_STORAGE_KEY: 'saborAcaiteriaCart',
        CUSTOMER_INFO_STORAGE_KEY: 'saborAcaiteriaCustomerInfo',
        ADMIN_SETTINGS_STORAGE_KEY: 'saborAcaiteriaAdminSettings',
        PRODUCTS_STORAGE_KEY: 'saborAcaiteriaProducts',
        TOPPINGS_STORAGE_KEY: 'saborAcaiteriaToppings',

        // --- DOM ELEMENT SELECTORS (cached for performance) ---
        elements: {
            productList: document.getElementById('product-list'),
            itemModal: document.getElementById('item-modal'),
            cartModal: document.getElementById('cart-modal'),
            confirmationModal: document.getElementById('confirmation-modal'),
            adminModal: document.getElementById('admin-modal'),
            cartButton: document.getElementById('cart-button'),
            alertModal: document.getElementById('alert-modal'),
            customerNameInput: document.getElementById('customer-name'),
            customerAddressInput: document.getElementById('customer-address'),
            neighborhoodSelect: document.getElementById('neighborhood'),
            deliveryFields: document.getElementById('delivery-fields'),
            deliveryOptionRadios: document.querySelectorAll('input[name="delivery_option"]'),
            passwordModal: document.getElementById('password-modal'),
            adminPasswordInput: document.getElementById('admin-password-input'),
            confirmActionModal: document.getElementById('confirm-action-modal'),
            deliveryTimeBanner: document.getElementById('delivery-time-banner'),
            storeHoursDisplay: document.getElementById('store-hours-display'),
            storeStatusIndicator: document.getElementById('store-status-indicator'),
            storeStatusBanner: document.getElementById('store-status-banner'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalItemTotal: document.getElementById('modal-item-total'),
            addToCartBtn: document.getElementById('add-to-cart-btn'),
            cartItemsContainer: document.getElementById('cart-items-container'),
            cartTotalEl: document.getElementById('cart-total'),
            cartCountEl: document.getElementById('cart-count'),
            checkoutForm: document.getElementById('checkout-form'),
            summaryDetails: document.getElementById('cart-summary-details'),
            cartSubtotal: document.getElementById('cart-subtotal'),
            cartDeliveryFee: document.getElementById('cart-delivery-fee'),
            deliveryOptionDelivery: document.getElementById('delivery-option-delivery'),
            deliveryOptionTakeout: document.getElementById('delivery-option-takeout'),
            paymentMethod: document.getElementById('payment-method'),
            observations: document.getElementById('observations'),
            orderSummary: document.getElementById('order-summary'),
            confirmationIcon: document.getElementById('confirmation-icon'),
            confirmationTitle: document.getElementById('confirmation-title'),
            confirmationMessage: document.getElementById('confirmation-message'),
            initialConfirmButtons: document.getElementById('initial-confirm-buttons'),
            postSendButtons: document.getElementById('post-send-buttons'),
            alertMessage: document.getElementById('alert-message'),
            alertTitle: document.getElementById('alert-title'),
            alertIcon: document.getElementById('alert-icon'),
            adminBody: document.getElementById('admin-body'),
            confirmActionMessage: document.getElementById('confirm-action-message'),
            confirmActionConfirmBtn: document.getElementById('confirm-action-confirm-btn'),
            confirmActionCancelBtn: document.getElementById('confirm-action-cancel-btn'),
            storeAddressDisplay: document.getElementById('store-address-display'),
            whatsappLink: document.getElementById('whatsapp-link'),
            messageButtonLink: document.getElementById('message-button-link'),
            comboSizeModal: document.getElementById('combo-size-modal'),
            comboSizeModalTitle: document.getElementById('combo-size-modal-title'),
            comboSizeModalBody: document.getElementById('combo-size-modal-body'),
            selectComboSizeBtn: document.getElementById('select-combo-size-btn'),
            onlineCount: document.getElementById('online-count'),
            closingTimerContainer: document.getElementById('closing-timer-container'),
            closingTimer: document.getElementById('closing-timer'),
            openingTimerContainer: document.getElementById('opening-timer-container'),
            openingTimer: document.getElementById('opening-timer'),
            deliveryCountdownContainer: document.getElementById('delivery-countdown-container'),
            deliveryCountdownTimer: document.getElementById('delivery-countdown-timer'),
            // NOVOS ELEMENTOS DO CUPOM
            couponCodeInput: document.getElementById('coupon-code'),
            applyCouponBtn: document.getElementById('apply-coupon-btn'),
            couponMessage: document.getElementById('coupon-message'),
            appliedCouponDisplay: document.getElementById('applied-coupon-display'),
            appliedCouponCode: document.getElementById('applied-coupon-code'),
        },

        // --- HELPER FUNCTIONS ---
        formatCurrency(value) {
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        },
        getNextOpeningDate() {
            const now = new Date();
            const [openHour, openMinute] = app.adminSettings.openingTime.split(':').map(Number);
            // Check for opening later today
            if (app.adminSettings.openDays.includes(now.getDay())) {
                const openingTimeToday = new Date();
                openingTimeToday.setHours(openHour, openMinute, 0, 0);
                if (now < openingTimeToday) {
                    return openingTimeToday;
                }
            }
            // Find the next open day
            for (let i = 1; i <= 7; i++) {
                const nextDate = new Date();
                nextDate.setDate(now.getDate() + i);
                const nextDayOfWeek = nextDate.getDay();
                if (app.adminSettings.openDays.includes(nextDayOfWeek)) {
                    nextDate.setHours(openHour, openMinute, 0, 0);
                    return nextDate;
                }
            }
            return null; // Should not happen if at least one day is open
        },

        // --- LOCAL STORAGE FUNCTIONS ---
        saveCart() {
            localStorage.setItem(app.CART_STORAGE_KEY, JSON.stringify(app.cart));
        },
        loadCart() {
            const savedCart = localStorage.getItem(app.CART_STORAGE_KEY);
            if (savedCart) app.cart = JSON.parse(savedCart);
        },
        saveCustomerInfo() {
            const info = {
                name: app.elements.customerNameInput.value,
                address: app.elements.customerAddressInput.value,
                neighborhood: app.elements.neighborhoodSelect.value,
                deliveryOption: document.querySelector('input[name="delivery_option"]:checked')?.value || 'delivery',
                paymentMethod: app.elements.paymentMethod.value,
                observations: app.elements.observations.value,
            };
            localStorage.setItem(app.CUSTOMER_INFO_STORAGE_KEY, JSON.stringify(info));
        },
        loadCustomerInfo() {
            const savedInfo = localStorage.getItem(app.CUSTOMER_INFO_STORAGE_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                app.elements.customerNameInput.value = info.name || '';
                app.elements.customerAddressInput.value = info.address || '';
                app.elements.neighborhoodSelect.value = info.neighborhood || '';
                app.elements.paymentMethod.value = info.paymentMethod || 'Pix';
                app.elements.observations.value = info.observations || '';
                
                // Restore delivery option
                const selectedDeliveryRadio = document.querySelector(`input[name="delivery_option"][value="${info.deliveryOption}"]`);
                if (selectedDeliveryRadio) {
                    selectedDeliveryRadio.checked = true;
                }
                app.toggleDeliveryFields();
            }
        },
        loadAdminSettings() {
            const savedSettings = localStorage.getItem(app.ADMIN_SETTINGS_STORAGE_KEY);
            app.adminSettings = savedSettings ? JSON.parse(savedSettings) : app.defaultAdminSettings;
            app.elements.storeAddressDisplay.textContent = app.adminSettings.address;
            app.elements.whatsappLink.href = `https://wa.me/${app.adminSettings.whatsappNumber}`;
            app.elements.messageButtonLink.href = `https://wa.me/${app.adminSettings.whatsappNumber}?text=Ol√°%20Gostaria%20de%20fazer%20um%20pedido%20de%20a√ßa√≠.`;
        },
        saveAdminSettings() {
             localStorage.setItem(app.ADMIN_SETTINGS_STORAGE_KEY, JSON.stringify(app.adminSettings));
        },
        loadProductsAndToppings() {
            const savedProducts = localStorage.getItem(app.PRODUCTS_STORAGE_KEY);
            const savedToppings = localStorage.getItem(app.TOPPINGS_STORAGE_KEY);
            app.products = savedProducts ? JSON.parse(savedProducts) : app.defaultProducts;
            app.toppings = savedToppings ? JSON.parse(savedToppings) : app.defaultToppings;
        },
        // FUN√á√ïES DO CUPOM
        loadUsedCoupons() {
            const savedCoupons = localStorage.getItem(app.COUPON_STORAGE_KEY);
            if (savedCoupons) app.coupon.usedCoupons = JSON.parse(savedCoupons);
        },
        saveUsedCoupons() {
            localStorage.setItem(app.COUPON_STORAGE_KEY, JSON.stringify(app.coupon.usedCoupons));
        },
        isCouponUsedToday(code) {
            const lastUsedDate = app.coupon.usedCoupons[code];
            if (!lastUsedDate) return false;
            const today = new Date().toISOString().split('T')[0];
            return lastUsedDate === today;
        },
        markCouponAsUsed(code) {
            const today = new Date().toISOString().split('T')[0];
            app.coupon.usedCoupons[code] = today;
            app.saveUsedCoupons();
        },
        applyCoupon() {
            const code = app.elements.couponCodeInput.value.toUpperCase().trim();
            if (!code) {
                app.elements.couponMessage.innerHTML = '<i class="fas fa-exclamation-triangle mr-1 text-yellow-500"></i><span class="text-yellow-500">Por favor, insira um c√≥digo de cupom.</span>';
                return;
            }
            
            // Check for empty cart
            if (app.cart.length === 0) {
                 app.elements.couponMessage.innerHTML = '<i class="fas fa-exclamation-triangle mr-1 text-yellow-500"></i><span class="text-yellow-500">O carrinho est√° vazio. Adicione itens antes de usar um cupom.</span>';
                return;
            }

            const couponData = app.COUPON_DISCOUNTS[code];
            if (!couponData) {
                app.elements.couponMessage.innerHTML = '<i class="fas fa-times-circle mr-1 text-red-500"></i><span class="text-red-500">Cupom inv√°lido.</span>';
                return;
            }
            
            // Check if the coupon has been used today
            if (app.isCouponUsedToday(code)) {
                app.elements.couponMessage.innerHTML = '<i class="fas fa-times-circle mr-1 text-red-500"></i><span class="text-red-500">Este cupom j√° foi utilizado hoje. Limite de 1 por dia.</span>';
                return;
            }

            if (app.coupon.applied && app.coupon.applied.code === code) {
                app.elements.couponMessage.innerHTML = '<i class="fas fa-info-circle mr-1 text-blue-400"></i><span class="text-blue-400">Este cupom j√° est√° aplicado.</span>';
                return;
            }

            // Apply the coupon
            app.coupon.applied = {
                code: code,
                type: couponData.type,
                value: couponData.value,
                message: couponData.message
            };
            app.elements.couponMessage.innerHTML = `<i class="fas fa-check-circle mr-1 text-green-500"></i><span class="text-green-500">${couponData.message}</span>`;
            app.renderCart();
        },
        removeCoupon() {
            app.coupon.applied = null;
            app.renderCart();
        },
        
        // --- CORE LOGIC FUNCTIONS ---
        updateCartCount() {
            const totalCount = app.cart.reduce((sum, item) => sum + item.quantity, 0);
            app.elements.cartCountEl.textContent = totalCount;
            if (totalCount > 0) {
                app.elements.cartButton.classList.remove('hidden');
            } else {
                app.elements.cartButton.classList.add('hidden');
                // Remove coupon if cart is empty
                app.removeCoupon();
            }
        },
        calculateItemTotal(item) {
            let total = item.basePrice * item.quantity;
            if (item.selectedToppings) {
                Object.keys(item.selectedToppings).forEach(groupId => {
                    const group = app.toppings[groupId];
                    const count = item.selectedToppings[groupId].length;
                    if (group.price) {
                        total += count * group.price * item.quantity;
                    } else if (group.limit && count > group.limit) {
                        // Charged for extra items beyond the limit
                        const price = app.toppings.paid_tier2.price || 0; // Assuming R$2.00 price for extra free items
                        const extraCount = count - group.limit;
                        total += extraCount * price * item.quantity;
                    }
                });
            }
            return total;
        },
        calculateCartTotal() {
            let subtotal = app.cart.reduce((sum, item) => sum + app.calculateItemTotal(item), 0);
            
            // 1. Calculate base delivery fee
            const selectedNeighborhood = app.elements.neighborhoodSelect.selectedOptions[0];
            let baseDeliveryFee = 0;
            if (app.getDeliveryOption() === 'delivery' && selectedNeighborhood && selectedNeighborhood.value) {
                baseDeliveryFee = parseFloat(selectedNeighborhood.getAttribute('data-fee')) || 0;
            }
            
            let totalDiscount = 0;
            let finalDeliveryFee = baseDeliveryFee;
            
            // 2. Apply Coupon Logic
            if (app.coupon.applied) {
                const coupon = app.coupon.applied;
                if (coupon.type === 'percentage') {
                    // Percentage discount on subtotal
                    totalDiscount = subtotal * coupon.value;
                } else if (coupon.type === 'free_delivery' && baseDeliveryFee > 0) {
                    // Free delivery (TAXA-0)
                    finalDeliveryFee = 0;
                }
            }

            // Ensure discount does not exceed subtotal
            totalDiscount = Math.min(totalDiscount, subtotal);
            
            const total = subtotal - totalDiscount + finalDeliveryFee;

            return { 
                subtotal, 
                baseDeliveryFee, 
                finalDeliveryFee, 
                totalDiscount, 
                total 
            };
        },
        renderProducts() {
            let html = '';
            app.products.forEach(product => {
                if (product.disabled) return;
                const basePrice = product.type === 'combo_selectable_size' ? Math.min(...app.cupSizes.map(s => s.price)) : product.price;
                const priceDisplay = product.type === 'combo_selectable_size' ? `A partir de ${app.formatCurrency(basePrice)}` : app.formatCurrency(basePrice);
                
                html += `
                    <div class="product-card bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col justify-between transition-all duration-300 transform" onclick="app.openItemModal(${product.id})">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">${product.name}</h3>
                            <p class="text-sm text-gray-400 mb-3">${product.description}</p>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-lg font-bold instagram-gradient-text">${priceDisplay}</span>
                            <button class="btn-gradient text-white font-bold py-2 px-4 rounded-lg text-sm">Montar</button>
                        </div>
                    </div>
                `;
            });
            app.elements.productList.innerHTML = html;
        },
        renderItemModal() {
            const product = app.currentItem.product;
            const isCustomAcai = product.type === 'base_acai' || product.type === 'combo';

            app.elements.modalTitle.textContent = `${product.name} ${product.size ? `(${product.size})` : ''}`;

            let contentHtml = '';
            let currentItemTotal = app.calculateItemTotal(app.currentItem);

            // 1. Quantity Selector
            contentHtml += `
                <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                    <label class="text-lg font-bold text-white">Quantidade</label>
                    <div class="flex items-center space-x-3">
                        <button onclick="app.updateItemQuantity(-1)" class="bg-gray-700 text-white w-8 h-8 rounded-full hover:bg-gray-600 disabled:opacity-50" ${app.currentItem.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <span id="item-quantity-display" class="text-xl font-bold text-pink-500 w-6 text-center">${app.currentItem.quantity}</span>
                        <button onclick="app.updateItemQuantity(1)" class="bg-gray-700 text-white w-8 h-8 rounded-full hover:bg-gray-600">+</button>
                    </div>
                </div>
            `;
            
            // 2. Toppings Section (Only for A√ßa√≠ Base and Combos that allow customization)
            if (isCustomAcai || product.type === 'combo_selectable_size') {
                Object.keys(app.toppings).forEach(groupKey => {
                    const group = app.toppings[groupKey];
                    let toppingLimit = group.limit || 0; 
                    
                    // Custom limits for specific products (like Barca)
                    if (product.customToppingLimits && product.customToppingLimits[groupKey] !== undefined) {
                        toppingLimit = product.customToppingLimits[groupKey];
                    }

                    const selectedItems = app.currentItem.selectedToppings[groupKey] || [];
                    const selectedCount = selectedItems.length;
                    const isPaidGroup = group.price && group.price > 0;
                    
                    let limitText = '';
                    let chargeText = '';
                    let countColor = selectedCount > toppingLimit ? 'text-red-400 font-bold' : 'text-green-400';

                    if (isPaidGroup) {
                        chargeText = `(+ ${app.formatCurrency(group.price)} cada)`;
                    } else if (toppingLimit > 0) {
                        limitText = `(Gr√°tis at√© ${toppingLimit} itens)`;
                        if (selectedCount > toppingLimit) {
                            const extraCost = (selectedCount - toppingLimit) * (app.toppings.paid_tier2.price || 2.00);
                            chargeText = `(+ ${app.formatCurrency(extraCost)} por excedente)`;
                        }
                    } else if (groupKey === 'caldas') {
                         limitText = `(Gr√°tis, escolha at√© 1)`;
                    }

                    contentHtml += `
                        <div class="space-y-3 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-bold text-white">${group.title.split('(')[0].trim()}</h4>
                                <span class="text-sm text-gray-400">${limitText} ${chargeText}</span>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                ${group.items.map(item => `
                                    <label class="flex items-center space-x-2 cursor-pointer p-2 bg-gray-900 rounded-md border border-gray-800 hover:border-pink-500 transition-colors">
                                        <input type="checkbox" data-group="${groupKey}" data-item="${item.name}" onchange="app.toggleTopping(event, '${groupKey}')" class="h-4 w-4 text-pink-500 border-gray-600 rounded focus:ring-pink-500" ${selectedItems.includes(item.name) ? 'checked' : ''} ${item.disabled ? 'disabled' : ''}>
                                        <span class="text-sm text-gray-300 ${item.disabled ? 'line-through text-gray-500' : ''}">${item.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <p class="text-sm ${countColor}">Selecionados: <span id="topping-count-${groupKey}">${selectedCount}</span></p>
                        </div>
                    `;
                });
            } else if (product.type === 'combo_selectable_size') {
                contentHtml += `<p class="text-center text-lg text-gray-400 p-4">Este item √© um combo pr√©-selecionado e n√£o permite personaliza√ß√£o de acompanhamentos.</p>`;
            }


            app.elements.modalBody.innerHTML = contentHtml;
            app.elements.modalItemTotal.textContent = app.formatCurrency(currentItemTotal);
            app.elements.addToCartBtn.textContent = app.currentItem.cartIndex !== null ? 'Atualizar Carrinho' : 'Adicionar ao Carrinho';
        },
        renderCart() {
            const { subtotal, baseDeliveryFee, finalDeliveryFee, totalDiscount, total } = app.calculateCartTotal();
            
            app.elements.cartTotalEl.textContent = app.formatCurrency(total);
            app.updateCartCount();

            // Render Cart Items
            let itemsHtml = app.cart.length === 0 ? '<p class="text-center text-gray-500">Seu carrinho est√° vazio.</p>' : '';
            if (app.cart.length > 0) {
                app.elements.checkoutForm.classList.remove('hidden');
                app.elements.summaryDetails.classList.remove('hidden');
                itemsHtml = app.cart.map((item, index) => {
                    const itemTotal = app.calculateItemTotal(item);
                    let toppingsList = item.selectedToppings ? Object.keys(item.selectedToppings).map(groupKey => {
                        const items = item.selectedToppings[groupKey];
                        if (items.length === 0) return '';
                        const group = app.toppings[groupKey];
                        const count = items.length;
                        let extraCharge = '';
                        // Calculate extra charge for 'free' groups if over limit
                        if (group.limit && count > group.limit && !group.price) {
                             const pricePerExtra = app.toppings.paid_tier2.price || 0;
                             const extraCount = count - group.limit;
                             extraCharge = ` (+ ${app.formatCurrency(extraCount * pricePerExtra * item.quantity)})`;
                        }
                        
                        // Calculate price for paid groups
                        let paidCharge = '';
                        if (group.price) {
                            paidCharge = ` (+ ${app.formatCurrency(group.price * count * item.quantity)})`;
                        }

                        return `
                            <p class="text-xs text-gray-500 ml-3 mt-1">
                                <span class="font-semibold">${group.title.split('(')[0].trim()}:</span> ${items.join(', ')} <span class="text-yellow-500">${extraCharge}</span><span class="text-yellow-500">${paidCharge}</span>
                            </p>
                        `;
                    }).filter(t => t).join('') : '';

                    return `
                        <div class="flex justify-between items-start bg-gray-800 p-4 rounded-lg shadow">
                            <div class="flex-1 min-w-0">
                                <p class="text-lg font-semibold text-white">${item.quantity}x ${item.name} (${item.size || item.product.name})</p>
                                ${toppingsList}
                            </div>
                            <div class="ml-4 text-right flex flex-col items-end min-w-[70px]">
                                <span class="text-xl font-bold text-pink-500">${app.formatCurrency(itemTotal)}</span>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="app.editCartItem(${index})" class="text-gray-400 hover:text-blue-400" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.removeCartItem(${index})" class="text-gray-400 hover:text-red-500" title="Remover"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('<div class="h-4"></div>');
            } else {
                app.elements.checkoutForm.classList.add('hidden');
                app.elements.summaryDetails.classList.add('hidden');
            }
            app.elements.cartItemsContainer.innerHTML = itemsHtml;


            // --- Render Summary Details with Discount ---
            
            // Check if a percentage discount was applied
            let discountDisplay = '';
            if (totalDiscount > 0) {
                discountDisplay = `
                    <div class="flex justify-between text-pink-400 font-semibold">
                        <span>Desconto (${app.coupon.applied.code})</span>
                        <span class="text-lg">- ${app.formatCurrency(totalDiscount)}</span>
                    </div>
                `;
            }

            // Update delivery fee display logic
            let feeDisplay;
            if (finalDeliveryFee === 0 && baseDeliveryFee > 0) {
                feeDisplay = `<span class="text-green-400">GR√ÅTIS (${app.coupon.applied.code})</span>`;
            } else if (finalDeliveryFee === 0 && baseDeliveryFee === 0) {
                feeDisplay = 'R$ 0,00';
            } else {
                feeDisplay = app.formatCurrency(finalDeliveryFee);
            }

            // Rebuild cart-summary-details content
            app.elements.summaryDetails.innerHTML = `
                <div class="flex justify-between text-gray-400">
                    <span>Subtotal</span>
                    <span id="cart-subtotal">${app.formatCurrency(subtotal)}</span>
                </div>
                ${discountDisplay}
                <div class="flex justify-between text-gray-400 ${totalDiscount > 0 ? 'border-t border-gray-700 pt-2' : ''}">
                    <span>Taxa de Entrega</span>
                    <span id="cart-delivery-fee">${feeDisplay}</span>
                </div>
            `;
            
            // Update the Coupon Display (The new HTML elements added)
            if (app.coupon.applied) {
                app.elements.appliedCouponCode.textContent = app.coupon.applied.code;
                app.elements.appliedCouponDisplay.classList.remove('hidden');
                app.elements.couponCodeInput.parentElement.classList.add('hidden'); // Hide input group
                app.elements.couponMessage.innerHTML = `<i class="fas fa-check-circle mr-1 text-green-500"></i><span class="text-green-500">${app.coupon.applied.message}</span>`;
            } else {
                app.elements.appliedCouponDisplay.classList.add('hidden');
                app.elements.couponCodeInput.parentElement.classList.remove('hidden'); // Show input group
                app.elements.couponMessage.textContent = '';
                app.elements.couponCodeInput.value = ''; // Clear input field
            }
        },
        toggleCartModal() {
            if (app.elements.cartModal.classList.contains('hidden')) {
                app.elements.cartModal.classList.add('flex');
                app.elements.cartModal.classList.remove('hidden');
                app.renderCart();
            } else {
                app.elements.cartModal.classList.remove('flex');
                app.elements.cartModal.classList.add('hidden');
            }
        },
        finalizeOrder() {
            app.saveCustomerInfo();
            
            if (app.cart.length === 0) {
                app.showAlert('O carrinho est√° vazio!', 'Aten√ß√£o', 'fas fa-exclamation-triangle text-yellow-500 text-5xl');
                return;
            }
            if (!app.elements.customerNameInput.value) {
                app.showAlert('Por favor, preencha seu nome.', 'Aten√ß√£o', 'fas fa-exclamation-triangle text-yellow-500 text-5xl');
                return;
            }
            if (app.getDeliveryOption() === 'delivery' && (!app.elements.neighborhoodSelect.value || !app.elements.customerAddressInput.value)) {
                app.showAlert('Por favor, selecione o bairro e preencha o endere√ßo completo para delivery.', 'Aten√ß√£o', 'fas fa-exclamation-triangle text-yellow-500 text-5xl');
                return;
            }

            // Mark coupon as used *before* generating confirmation and sending, to prevent re-use today.
            if (app.coupon.applied) {
                app.markCouponAsUsed(app.coupon.applied.code);
            }
            
            app.whatsAppMessage = app.generateWhatsAppMessage();
            app.renderOrderSummary();
            app.toggleCartModal(); // Close cart modal
            app.openConfirmationModal(); // Open confirmation modal
        },
        generateWhatsAppMessage() {
            const customerName = app.elements.customerNameInput.value.trim();
            const deliveryOption = app.getDeliveryOption();
            const paymentMethod = app.elements.paymentMethod.value;
            const observations = app.elements.observations.value.trim();
            const { subtotal, finalDeliveryFee, total, baseDeliveryFee, totalDiscount } = app.calculateCartTotal();

            let message = `*PEDIDO SABOR A√áA√çTERIA*\n\n`;
            message += `*Cliente*: ${customerName}\n`;
            
            // Order Items
            message += `\n*--- ITENS DO PEDIDO (${app.cart.length} itens) ---*\n`;
            app.cart.forEach((item, index) => {
                const itemTotal = app.calculateItemTotal(item);
                let toppingsText = '';
                if (item.selectedToppings) {
                    toppingsText = Object.keys(item.selectedToppings).map(groupKey => {
                        const items = item.selectedToppings[groupKey];
                        if (items.length === 0) return '';
                        const group = app.toppings[groupKey];
                        const count = items.length;
                        
                        // Check for charged items (paid group or extra free items)
                        let extraInfo = '';
                        if (group.price) {
                            extraInfo = ` (R$ ${group.price.toFixed(2).replace('.', ',')} cada)`;
                        } else if (group.limit && count > group.limit) {
                            const pricePerExtra = app.toppings.paid_tier2.price || 0;
                            const extraCount = count - group.limit;
                            extraInfo = ` (${extraCount} extra(s) +R$ ${pricePerExtra.toFixed(2).replace('.', ',')} cada)`;
                        }
                        
                        return `   ‚Ä¢ ${group.title.split('(')[0].trim()}${extraInfo}: ${items.join(', ')}`;
                    }).filter(t => t).join('\n');
                }
                
                message += `\n*${index + 1}. ${item.quantity}x ${item.name} (${item.size || item.product.name})* - ${app.formatCurrency(itemTotal)}\n`;
                if (toppingsText) message += `${toppingsText}\n`;
            });
            
            // Coupon/Discount (NEW ADDITION)
            if (app.coupon.applied) {
                const couponCode = app.coupon.applied.code;
                message += `\n*--- CUPOM ---*\n`;
                message += `Cupom Aplicado: *${couponCode}*\n`;
                
                if (totalDiscount > 0) {
                    message += `Desconto no Subtotal: *-${app.formatCurrency(totalDiscount)}*\n`;
                }
                if (app.coupon.applied.type === 'free_delivery' && baseDeliveryFee > 0) {
                    message += `Desconto na Taxa de Entrega: *-${app.formatCurrency(baseDeliveryFee)}* (TAXA-0)\n`;
                }
            }


            // Summary
            message += `\n*--- RESUMO ---*\n`;
            message += `Subtotal: ${app.formatCurrency(subtotal)}\n`;
            message += `Taxa de Entrega: ${finalDeliveryFee > 0 ? app.formatCurrency(finalDeliveryFee) : 'GR√ÅTIS'}\n`;
            message += `*TOTAL DO PEDIDO: ${app.formatCurrency(total)}*\n`;

            // Delivery/Takeout Info
            message += `\n*--- ENTREGA/RETIRADA ---*\n`;
            message += `Op√ß√£o: ${deliveryOption === 'delivery' ? 'Entrega (Delivery)' : 'Retirar na Loja (Takeout)'}\n`;
            if (deliveryOption === 'delivery') {
                const neighborhood = app.elements.neighborhoodSelect.selectedOptions[0]?.textContent || '';
                message += `Bairro: ${neighborhood.split('(')[0].trim()}\n`;
                message += `Endere√ßo: ${app.elements.customerAddressInput.value.trim()}\n`;
            }

            // Payment & Observations
            message += `\n*--- PAGAMENTO E OBSERVA√á√ïES ---*\n`;
            message += `Pagamento: ${paymentMethod}\n`;
            if (observations) {
                message += `Obs: ${observations}\n`;
            } else {
                 message += `Obs: Nenhuma\n`;
            }

            return encodeURIComponent(message);
        },
        renderOrderSummary() {
            const { subtotal, finalDeliveryFee, total, totalDiscount, baseDeliveryFee } = app.calculateCartTotal();

            let summaryHtml = '';
            
            // Items list
            summaryHtml += app.cart.map((item, index) => {
                const itemTotal = app.calculateItemTotal(item);
                const toppingsList = item.selectedToppings ? Object.keys(item.selectedToppings).map(groupKey => {
                    const items = item.selectedToppings[groupKey];
                    if (items.length === 0) return '';
                    const group = app.toppings[groupKey];
                    
                    let extraInfo = '';
                    const count = items.length;
                    if (group.price) {
                        extraInfo = ` (+${app.formatCurrency(group.price * count)})`;
                    } else if (group.limit && count > group.limit) {
                        const pricePerExtra = app.toppings.paid_tier2.price || 0;
                        const extraCount = count - group.limit;
                        extraInfo = ` (+${app.formatCurrency(extraCount * pricePerExtra)})`;
                    }

                    return `<span class="text-xs text-gray-500 block">${group.title.split('(')[0].trim()}: ${items.join(', ')}<span class="text-yellow-500">${extraInfo}</span></span>`;
                }).join('') : '';

                return `
                    <div class="py-2 border-b border-gray-700 last:border-b-0">
                        <div class="flex justify-between">
                            <span class="font-semibold text-white">${item.quantity}x ${item.name} (${item.size || item.product.name})</span>
                            <span class="font-bold text-pink-400">${app.formatCurrency(itemTotal)}</span>
                        </div>
                        ${toppingsList}
                    </div>
                `;
            }).join('');
            
            // Totals
            summaryHtml += `<div class="mt-4 pt-2 border-t border-gray-700 space-y-1">`;
            summaryHtml += `<div class="flex justify-between text-gray-400"><span>Subtotal:</span><span>${app.formatCurrency(subtotal)}</span></div>`;
            
            // Discount display (NEW ADDITION)
            if (totalDiscount > 0) {
                 summaryHtml += `<div class="flex justify-between text-pink-400 font-semibold"><span>Desconto (${app.coupon.applied.code}):</span><span>- ${app.formatCurrency(totalDiscount)}</span></div>`;
            }

            let feeText = finalDeliveryFee > 0 ? app.formatCurrency(finalDeliveryFee) : (baseDeliveryFee > 0 ? `<span class="text-green-400">GR√ÅTIS (${app.coupon.applied.code})</span>` : 'R$ 0,00');
            summaryHtml += `<div class="flex justify-between text-gray-400"><span>Entrega:</span><span>${feeText}</span></div>`;

            summaryHtml += `<div class="flex justify-between text-xl font-bold mt-2 pt-2 border-t border-gray-700 text-white"><span>TOTAL:</span><span class="instagram-gradient-text">${app.formatCurrency(total)}</span></div>`;
            summaryHtml += `</div>`;
            
            // Customer Info
            const deliveryOption = app.getDeliveryOption();
            const neighborhoodText = deliveryOption === 'delivery' ? (app.elements.neighborhoodSelect.selectedOptions[0]?.textContent || 'Bairro n√£o selecionado') : '';
            const addressText = deliveryOption === 'delivery' ? app.elements.customerAddressInput.value.trim() : 'Retirada na Loja';

            summaryHtml += `<div class="mt-4 pt-4 border-t border-gray-700 text-sm space-y-1">
                <p><span class="font-semibold text-white">Nome:</span> ${app.elements.customerNameInput.value.trim()}</p>
                <p><span class="font-semibold text-white">Op√ß√£o:</span> ${deliveryOption === 'delivery' ? 'Delivery' : 'Retirar na Loja'}</p>
                ${deliveryOption === 'delivery' ? `<p><span class="font-semibold text-white">Bairro:</span> ${neighborhoodText.split('(')[0].trim()}</p>` : ''}
                <p><span class="font-semibold text-white">Endere√ßo:</span> ${addressText}</p>
                <p><span class="font-semibold text-white">Pagamento:</span> ${app.elements.paymentMethod.value}</p>
                <p><span class="font-semibold text-white">Obs:</span> ${app.elements.observations.value.trim() || 'Nenhuma'}</p>
            </div>`;

            app.elements.orderSummary.innerHTML = summaryHtml;
        },
        getDeliveryOption() {
            return document.querySelector('input[name="delivery_option"]:checked').value;
        },
        toggleDeliveryFields() {
            const isDelivery = app.getDeliveryOption() === 'delivery';
            if (isDelivery) {
                app.elements.deliveryFields.classList.remove('hidden');
                app.elements.deliveryOptionDelivery.querySelector('div').classList.remove('border-gray-600');
                app.elements.deliveryOptionDelivery.querySelector('div').classList.add('border-pink-500');
                app.elements.deliveryOptionTakeout.querySelector('div').classList.remove('border-pink-500');
                app.elements.deliveryOptionTakeout.querySelector('div').classList.add('border-gray-600');
            } else {
                app.elements.deliveryFields.classList.add('hidden');
                app.elements.deliveryOptionDelivery.querySelector('div').classList.remove('border-pink-500');
                app.elements.deliveryOptionDelivery.querySelector('div').classList.add('border-gray-600');
                app.elements.deliveryOptionTakeout.querySelector('div').classList.remove('border-gray-600');
                app.elements.deliveryOptionTakeout.querySelector('div').classList.add('border-pink-500');
            }
            app.renderCart(); 
        },
        openItemModal(productId, size = null, cartIndex = null) {
            const product = app.products.find(p => p.id === productId);
            if (!product) return;

            if (product.type === 'combo_selectable_size' && !size) {
                app.selectedComboProductId = productId;
                app.openComboSizeModal(product);
                return;
            }

            // If editing, use existing item data
            if (cartIndex !== null) {
                app.currentItem = { ...app.cart[cartIndex], cartIndex };
            } else {
                // New item
                const basePrice = product.price || app.cupSizes.find(s => s.name === size).price;
                app.currentItem = {
                    product,
                    basePrice,
                    size,
                    name: product.name,
                    quantity: 1,
                    selectedToppings: app.deepClone(app.defaultToppingsForProduct(product)),
                    cartIndex: null
                };
            }
            
            app.renderItemModal();
            app.elements.itemModal.classList.add('flex');
            app.elements.itemModal.classList.remove('hidden');
        },
        closeItemModal() {
            app.elements.itemModal.classList.remove('flex');
            app.elements.itemModal.classList.add('hidden');
            app.currentItem = null;
        },
        openComboSizeModal(product) {
            app.elements.comboSizeModalTitle.textContent = `Escolha o Tamanho para ${product.name}`;
            let html = '';
            app.cupSizes.forEach(size => {
                html += `
                    <label>
                        <input type="radio" name="combo_size" value="${size.name}" data-price="${size.price}" class="hidden">
                        <div class="flex justify-between items-center p-4 border-2 border-gray-600 rounded-xl cursor-pointer transition-all hover:border-pink-500">
                            <span class="text-lg font-semibold text-white">${size.name}</span>
                            <span class="text-xl font-bold text-pink-500">${app.formatCurrency(size.price)}</span>
                        </div>
                    </label>
                `;
            });
            app.elements.comboSizeModalBody.innerHTML = html;
            
            const radioButtons = app.elements.comboSizeModalBody.querySelectorAll('input[name="combo_size"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', () => {
                    app.elements.selectComboSizeBtn.disabled = !document.querySelector('input[name="combo_size"]:checked');
                });
            });

            app.elements.selectComboSizeBtn.onclick = () => {
                const selectedSize = document.querySelector('input[name="combo_size"]:checked');
                if (selectedSize) {
                    app.closeComboSizeModal();
                    app.openItemModal(app.selectedComboProductId, selectedSize.value);
                }
            };
            app.elements.selectComboSizeBtn.disabled = true; // Start disabled

            app.elements.comboSizeModal.classList.add('flex');
            app.elements.comboSizeModal.classList.remove('hidden');
        },
        closeComboSizeModal() {
            app.elements.comboSizeModal.classList.remove('flex');
            app.elements.comboSizeModal.classList.add('hidden');
            app.selectedComboProductId = null;
        },
        updateItemQuantity(change) {
            app.currentItem.quantity += change;
            if (app.currentItem.quantity < 1) app.currentItem.quantity = 1;
            app.renderItemModal();
        },
        toggleTopping(event, groupKey) {
            const itemName = event.target.getAttribute('data-item');
            const isChecked = event.target.checked;
            
            let selectedItems = app.currentItem.selectedToppings[groupKey] || [];

            if (isChecked) {
                // If it's a paid group, just add it.
                // If it's a free group with limit 1 (caldas), uncheck others before adding.
                if (groupKey === 'caldas' && app.toppings.caldas.limit === 1) {
                    selectedItems.forEach(item => {
                        const existingCheckbox = document.querySelector(`input[data-group="${groupKey}"][data-item="${item}"]`);
                        if (existingCheckbox && existingCheckbox.checked) {
                            existingCheckbox.checked = false;
                        }
                    });
                    selectedItems = [];
                    selectedItems.push(itemName);
                } else {
                    selectedItems.push(itemName);
                }
            } else {
                const index = selectedItems.indexOf(itemName);
                if (index > -1) {
                    selectedItems.splice(index, 1);
                }
            }
            app.currentItem.selectedToppings[groupKey] = selectedItems;
            app.renderItemModal();
        },
        defaultToppingsForProduct(product) {
             const defaultToppings = {};
             // For customizable products, start with empty selection
             if (product.type === 'base_acai' || product.type === 'combo' || product.type === 'combo_selectable_size') {
                 Object.keys(app.toppings).forEach(key => {
                     defaultToppings[key] = [];
                 });
                 return defaultToppings;
             }
             return {};
        },
        addToCart() {
            // CORRE√á√ÉO: CRIA√á√ÉO DE C√ìPIA PROFUNDA (DEEP CLONE)
            
            // Remove helper properties before saving to cart (cartIndex is not needed in the cart array)
            const itemToAdd = app.deepClone(app.currentItem);
            delete itemToAdd.cartIndex;
            
            if (app.currentItem.cartIndex !== null) {
                // Update existing item
                app.cart[app.currentItem.cartIndex] = itemToAdd;
            } else {
                // Add new item (using the deep clone)
                app.cart.push(itemToAdd);
            }
            
            app.saveCart();
            app.updateCartCount();
            app.currentItem = null;
        },
        editCartItem(index) {
            app.toggleCartModal();
            const item = app.cart[index];
            app.openItemModal(item.product.id, item.size, index);
        },
        removeCartItem(index) {
            app.cart.splice(index, 1);
            app.saveCart();
            app.renderCart();
        },
        sendOrderViaWhatsApp() {
            window.open(`https://wa.me/${app.adminSettings.whatsappNumber}?text=${app.whatsAppMessage}`, '_blank');
            
            app.elements.initialConfirmButtons.classList.add('hidden');
            app.elements.postSendButtons.classList.remove('hidden');
            
            app.elements.confirmationIcon.innerHTML = `<i class="fas fa-paper-plane text-blue-500 text-6xl mb-4"></i>`;
            app.elements.confirmationTitle.textContent = 'Mensagem Enviada!';
            app.elements.confirmationMessage.textContent = 'Agora confirme o envio para limpar seu carrinho e pronto!';
        },
        confirmOrderSent() {
            app.cart = [];
            app.saveCart();
            app.updateCartCount();
            app.closeConfirmationModal();
            app.showAlert('O carrinho foi limpo com sucesso!', 'Pronto!', 'fas fa-check-circle text-green-500 text-5xl');
        },
        openConfirmationModal() {
            app.elements.confirmationModal.classList.add('flex');
            app.elements.confirmationModal.classList.remove('hidden');
            app.elements.initialConfirmButtons.classList.remove('hidden');
            app.elements.postSendButtons.classList.add('hidden');
            app.elements.confirmationIcon.innerHTML = `<i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>`;
            app.elements.confirmationTitle.textContent = 'Pedido Recebido!';
            app.elements.confirmationMessage.textContent = 'Seu pedido foi gerado! Clique no bot√£o abaixo para encaminh√°-lo para o WhatsApp da loja e finalizar a compra.';
        },
        closeConfirmationModal() {
            app.elements.confirmationModal.classList.remove('flex');
            app.elements.confirmationModal.classList.add('hidden');
        },
        showAlert(message, title = 'Aten√ß√£o', iconHtml = '<i class="fas fa-exclamation-triangle text-yellow-500 text-5xl"></i>') {
            app.elements.alertMessage.textContent = message;
            app.elements.alertTitle.textContent = title;
            app.elements.alertIcon.innerHTML = iconHtml;
            app.elements.alertModal.classList.add('flex');
            app.elements.alertModal.classList.remove('hidden');
        },
        closeAlertModal() {
            app.elements.alertModal.classList.remove('flex');
            app.elements.alertModal.classList.add('hidden');
        },
        openAdminPanel(event) {
            event.preventDefault();
            app.elements.adminPasswordInput.value = '';
            app.elements.passwordModal.classList.add('flex');
            app.elements.passwordModal.classList.remove('hidden');
        },
        closeAdminModal() {
            app.elements.adminModal.classList.remove('flex');
            app.elements.adminModal.classList.add('hidden');
        },
        closePasswordModal() {
            app.elements.passwordModal.classList.remove('flex');
            app.elements.passwordModal.classList.add('hidden');
        },
        checkAdminPassword() {
            const password = app.elements.adminPasswordInput.value;
            // Simplified for this context: default password
            if (password === 'admin123') {
                app.closePasswordModal();
                app.renderAdminPanel();
                app.elements.adminModal.classList.add('flex');
                app.elements.adminModal.classList.remove('hidden');
            } else {
                app.showAlert('Senha incorreta.', 'Erro de Acesso', '<i class="fas fa-lock text-red-500 text-5xl"></i>');
                app.elements.adminPasswordInput.value = '';
            }
        },
        deepClone(obj) {
            // CORRE√á√ÉO: Fun√ß√£o para criar uma c√≥pia profunda, essencial para o carrinho.
            return JSON.parse(JSON.stringify(obj));
        },
        updateStoreStatus() {
            const now = new Date();
            const currentDay = now.getDay();
            const dayOfWeek = currentDay;
            const openDays = app.adminSettings.openDays;

            const [openHour, openMinute] = app.adminSettings.openingTime.split(':').map(Number);
            const [closeHour, closeMinute] = app.adminSettings.closingTime.split(':').map(Number);

            const openingTime = new Date();
            openingTime.setHours(openHour, openMinute, 0, 0);
            const closingTime = new Date();
            closingTime.setHours(closeHour, closeMinute, 0, 0);

            app.isStoreOpen = false;
            let statusText = 'Fechado';
            let statusClass = 'bg-red-500';

            // 1. Check Manual/Forced Status
            if (app.adminSettings.storeStatus === 'open') {
                app.isStoreOpen = true;
                statusText = 'Aberto (For√ßado)';
                statusClass = 'bg-green-500';
            } else if (app.adminSettings.storeStatus === 'closed') {
                app.isStoreOpen = false;
                statusText = 'Fechado (For√ßado)';
                statusClass = 'bg-red-500';
            } 
            // 2. Check Auto Status
            else if (openDays.includes(dayOfWeek)) {
                if (now >= openingTime && now < closingTime) {
                    app.isStoreOpen = true;
                    statusText = 'Aberto Agora';
                    statusClass = 'bg-green-500';
                } else if (now < openingTime) {
                    statusText = 'Fechado. Abre em breve.';
                    statusClass = 'bg-yellow-500';
                } else {
                    statusText = 'Fechado. Reabre amanh√£ ou no pr√≥ximo dia aberto.';
                    statusClass = 'bg-red-500';
                }
            } else {
                statusText = 'Fechado. Reabre no pr√≥ximo dia aberto.';
                statusClass = 'bg-red-500';
            }

            // Update UI elements
            app.elements.storeHoursDisplay.textContent = `Hoje: ${app.adminSettings.openingTime} √†s ${app.adminSettings.closingTime}`;
            app.elements.storeStatusIndicator.textContent = statusText.split(' ')[0];
            app.elements.storeStatusIndicator.className = `ml-2 px-2 py-0.5 text-xs rounded-full font-semibold text-white ${statusClass}`;

            // Show or hide main store status banner
            if (app.isStoreOpen) {
                app.elements.storeStatusBanner.classList.add('hidden');
                app.elements.closingTimerContainer.classList.remove('hidden');
                app.elements.openingTimerContainer.classList.add('hidden');
            } else {
                app.elements.storeStatusBanner.classList.remove('hidden');
                app.elements.closingTimerContainer.classList.add('hidden');
                
                // If not forced closed, calculate next opening time
                if (app.adminSettings.storeStatus !== 'closed') {
                    app.elements.openingTimerContainer.classList.remove('hidden');
                } else {
                    app.elements.openingTimerContainer.classList.add('hidden');
                }

                app.elements.storeStatusBanner.innerHTML = `
                    <div class="bg-red-800 bg-opacity-70 p-4 rounded-lg flex items-center gap-3">
                        <i class="fas fa-times-circle text-2xl text-red-400"></i>
                        <div>
                            <p class="font-bold text-white">${statusText}</p>
                            <p class="text-sm text-gray-300">Aceitamos pedidos apenas durante o hor√°rio de funcionamento.</p>
                        </div>
                    </div>
                `;
            }

            // Delivery Countdown logic (assuming delivery starts at store open, or a specific time)
            const [deliveryStartHour, deliveryStartMinute] = app.isWeekend(dayOfWeek) 
                ? app.adminSettings.weekendDeliveryStartTime.split(':').map(Number)
                : app.adminSettings.weekdayDeliveryStartTime.split(':').map(Number);

            const deliveryStartTime = new Date();
            deliveryStartTime.setHours(deliveryStartHour, deliveryStartMinute, 0, 0);

            if (app.isStoreOpen && now < deliveryStartTime && app.getDeliveryOption() === 'delivery') {
                app.elements.deliveryCountdownContainer.classList.remove('hidden');
                app.isDeliveryTime = false;
            } else if (app.isStoreOpen) {
                app.elements.deliveryCountdownContainer.classList.add('hidden');
                app.isDeliveryTime = true;
            } else {
                 app.elements.deliveryCountdownContainer.classList.add('hidden');
                 app.isDeliveryTime = false;
            }
        },
        isWeekend(day) {
            return day === 0 || day === 6; // Sunday or Saturday
        },
        updateTimers() {
            const now = new Date();
            const [closeHour, closeMinute] = app.adminSettings.closingTime.split(':').map(Number);
            const [deliveryStartHour, deliveryStartMinute] = app.isWeekend(now.getDay()) 
                ? app.adminSettings.weekendDeliveryStartTime.split(':').map(Number)
                : app.adminSettings.weekdayDeliveryStartTime.split(':').map(Number);

            // 1. Closing Timer
            if (app.isStoreOpen) {
                const closingTime = new Date();
                closingTime.setHours(closeHour, closeMinute, 0, 0);
                
                let diff = closingTime.getTime() - now.getTime();
                if (diff < 0) {
                    // Time to close or already closed (if status is 'auto')
                    diff += 24 * 60 * 60 * 1000; // Add 24h to show time until next day closing if logic allows
                }

                const hours = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, '0');
                const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
                app.elements.closingTimer.textContent = `${hours}:${minutes}:${seconds}`;

                if (diff < 5 * 60 * 1000 && diff > 0) { // Less than 5 minutes
                     app.elements.closingTimerContainer.classList.add('bg-red-900', 'border-red-500');
                     app.elements.closingTimerContainer.classList.remove('bg-gray-900', 'border-gray-700');
                } else {
                    app.elements.closingTimerContainer.classList.remove('bg-red-900', 'border-red-500');
                    app.elements.closingTimerContainer.classList.add('bg-gray-900', 'border-gray-700');
                }
            }

            // 2. Opening Timer
            if (!app.isStoreOpen && app.adminSettings.storeStatus !== 'closed') {
                const nextOpen = app.getNextOpeningDate();
                if (nextOpen) {
                    let diff = nextOpen.getTime() - now.getTime();
                    if (diff < 0) diff = 0;

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = String(Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0');
                    const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                    const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
                    
                    if (days > 0) {
                        app.elements.openingTimer.textContent = `${days}d ${hours}h`;
                    } else {
                        app.elements.openingTimer.textContent = `${hours}:${minutes}:${seconds}`;
                    }
                }
            }

            // 3. Delivery Countdown Timer
             if (!app.isDeliveryTime && app.isStoreOpen) {
                const deliveryStartTime = new Date();
                deliveryStartTime.setHours(deliveryStartHour, deliveryStartMinute, 0, 0);

                let diff = deliveryStartTime.getTime() - now.getTime();
                 if (diff <= 0) {
                     app.updateStoreStatus(); // Trigger status update to hide timer
                     return;
                 }

                const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
                app.elements.deliveryCountdownTimer.textContent = `${minutes}:${seconds}`;
            }

            // Update status every 5 seconds (important for open/close detection)
            if (now.getSeconds() % 5 === 0) {
                 app.updateStoreStatus();
            }
        },
        initializeApp() {
            app.loadAdminSettings();
            app.loadProductsAndToppings();
            app.loadCart();
            app.loadCustomerInfo();
            app.loadUsedCoupons(); // <-- NOVO: Carregar cupons usados
            
            app.renderProducts();
            app.updateStoreStatus();
            app.renderCart(); // Call once on init to show button if cart has items
            app.setupEventListeners();

            // Setup timers
            app.updateTimers();
            app.countdownInterval = setInterval(app.updateTimers, 1000);
        },
        setupEventListeners() {
            app.elements.addToCartBtn.addEventListener('click', () => { app.addToCart(); app.closeItemModal(); });
            app.elements.customerNameInput.addEventListener('input', app.saveCustomerInfo);
            app.elements.customerAddressInput.addEventListener('input', app.saveCustomerInfo);
            app.elements.neighborhoodSelect.addEventListener('change', () => { app.saveCustomerInfo(); app.renderCart(); });
            // CORRE√á√ÉO: Chamada para app.removeCoupon() ao mudar a op√ß√£o de entrega
            app.elements.deliveryOptionRadios.forEach(radio => radio.addEventListener('change', () => { app.toggleDeliveryFields(); app.saveCustomerInfo(); app.removeCoupon(); app.renderCart(); })); 
            app.elements.paymentMethod.addEventListener('change', app.saveCustomerInfo);
            app.elements.observations.addEventListener('input', app.saveCustomerInfo);
            app.elements.adminPasswordInput.addEventListener('keypress', e => { if (e.key === 'Enter') app.checkAdminPassword(); });
            
            // NOVOS EVENT LISTENERS DO CUPOM
            app.elements.applyCouponBtn.addEventListener('click', app.applyCoupon);
            app.elements.couponCodeInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    app.applyCoupon(); 
                }
            });
            // O removeCoupon() est√° ligado ao bot√£o dentro do HTML de applied-coupon-display
        }
    };
    
    // Simplified Admin Panel Render/Save for this context
    app.renderAdminPanel = () => { app.elements.adminBody.innerHTML = `<p class="text-center">A interface do painel de administra√ß√£o foi mantida funcional e n√£o segue o tema escuro.</p><p class="text-center mt-4">Clique em "Salvar" para aplicar as configura√ß√µes atuais ou "Restaurar" para limpar os dados.</p>`; }
    app.saveAdminChanges = () => { app.showAlert('As configura√ß√µes foram salvas.', 'Salvo'); app.closeAdminModal(); }
    app.resetToDefaults = () => {
        localStorage.clear();
        app.showAlert('Configura√ß√µes restauradas! A p√°gina ser√° recarregada.', 'Sucesso');
        setTimeout(() => window.location.reload(), 2000);
    }

    document.addEventListener('DOMContentLoaded', app.initializeApp);
    </script>
</body>
</html>
